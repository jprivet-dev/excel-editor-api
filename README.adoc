// Enable keyboard shortcuts
:experimental:

:toc: macro
:toc-title: Summary
:toclevels: 3
:numbered:

ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

:back_to_top_target: top-target
:back_to_top_label: â¬† Back to top
:back_to_top: <<{back_to_top_target},{back_to_top_label}>>

:main_title: Excel Editor (API with Symfony)
:git_project_base: excel-editor
:git_project_api: {git_project_base}-api
:git_project_spa: {git_project_base}-spa
:git_project_insomnia: {git_project_base}-insomnia
:git_username: jprivet-dev
:git_url_api: https://github.com/{git_username}/{git_project_api}
:git_url_spa: https://github.com/{git_username}/{git_project_spa}
:git_url_insomnia: https://github.com/{git_username}/{git_project_insomnia}
:git_ssh_api: git@github.com:{git_username}/{git_project_api}
:git_ssh_spa: git@github.com:{git_username}/{git_project_spa}
:git_clone_ssh_api: git@github.com:{git_username}/{git_project_api}.git
:git_clone_ssh_spa: git@github.com:{git_username}/{git_project_spa}.git

:git_project_current: {git_project_api}
:git_url_current: {git_url_api}
:git_ssh_current: {git_ssh_api}

// Releases
:project_release: v0.0.0-beta.3
:php_release: 8.2.0
:php_release_underscore: 8_2_0
:symfony_release: v6.1.10

[#{back_to_top_target}]
= {main_title}

image:https://badgen.net/badge/release/{project_release}/blue[Project release,link=https://github.com/jprivet-dev/excel-editor-api/releases/tag/{project_release}]
image:https://badgen.net/badge/php/{php_release}/7A86B8[PHP release,link=https://www.php.net/releases/{php_release_underscore}.php]
image:https://badgen.net/badge/symfony/{symfony_release}/73D631[Symfony release,link=https://github.com/symfony/symfony/releases/tag/{symfony_release}]
image:https://app.codacy.com/project/badge/Grade/65cecce3bac34c71ba7ba9035bbcabce["Codacy code quality", link="https://www.codacy.com/gh/jprivet-dev/excel-editor-api/dashboard?utm_source=github.com&utm_medium=referral&utm_content=jprivet-dev/excel-editor-api&utm_campaign=Badge_Grade"]

toc::[]

== Presentation

Study of an API (Symfony) and a SPA (Angular), to load data in CSV/Excel format, with consultation and modification of this data online.

|===
| API (Symfony/Docker) | {git_url_api}
| SPA (Angular/Docker) | {git_url_spa}
| Insomnia - design, debug and test the API (https://insomnia.rest/) | {git_url_insomnia}
|===

{back_to_top}

== Prerequisites

Be sure to install the latest version of *Docker Compose CLI* plugin (https://docs.docker.com/compose/install/compose-plugin/). With the older generation of docker compose, I had encountered the following error:

```
$ docker-compose build --pull --no-cache
...
Status: Downloaded newer image for composer:2
 ---> daa583eddaba
Step 27/31 : COPY composer.* symfony.* ./
COPY failed: no source files were specified
ERROR: Service 'php' failed to build : Build failed
```

Problem solved with the latest generation:

```
$ docker compose build --pull --no-cache
```

{back_to_top}

== Installation

. `$ git clone {git_ssh_current}`.
. `$ cd {git_project_current}`.
. `$ make build`: Build (the first time) or rebuild fresh images if necessary.
. `$ make start`: Create and start containers (alias of `$ make up`).
. `$ make generate_keypair`: (the first time) Generate the SSL keys for the JWT authentication.
. Open https://localhost and https://stackoverflow.com/a/15076602/1352334[accept the auto-generated TLS certificate].
. `$ make stop`: (down) Stop and remove containers, networks.

NOTE: `$ make` to see all available commands.

{back_to_top}

== API documentation with Nelmio

NOTE: This project use https://github.com/nelmio/NelmioApiDocBundle

Go on https://localhost/api/doc to see the API documentation.

image::doc/img/nelmio-api-doc.png[]

{back_to_top}

== Docker environments

When you run `$ docker compose up` it reads the overrides automatically (`docker-compose.yml` and `docker-compose.override.yml`).

To deploy with this production Compose file you can run:

```
$  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

{back_to_top}

== PHPStorm configuration

IMPORTANT: The following configuration are provided for *PHPStorm 2022.3.1*

{back_to_top}

=== Docker Compose-based remote PHP interpreter

. In the *Settings/Preferences* dialog (kbd:[Ctrl+Alt+S]), go to *PHP*.
. On the *PHP* page that opens, click the Browse button kbd:[...] next to the *CLI Interpreter* list.
. In the *CLI Interpreters* dialog that opens, select "From Docker, Vagrant, VM, WSL, Remote...".
. In the *Configure Remote PHP Interpreter* dialog that opens, select "Docker" :
** *Server:* Docker
** *Image name:* excel-editor-api-php:latest
** *PHP interpreter path:* php
. In the *Configure Remote PHP Interpreter* dialog, click the button *OK*.
. In the *CLI Interpreters* dialog, click the button *OK*.

image::doc/img/phpstorm-settings-php.png[]

{back_to_top}

=== PHP_CodeSniffer script associated with a PHP interpreter

==== Installation

NOTE: See https://github.com/squizlabs/PHP_CodeSniffer

Include a dependency for `squizlabs/php_codesniffer` in the `composer.json` file:

```json
{
    "require-dev": {
        "squizlabs/php_codesniffer": "3.*"
    }
}
```

And update all:

```
$ make composer c=update    # with Makefile
# OR
$ composer update           # with .bash_aliases
```

{back_to_top}

==== Configuration

NOTE: See https://www.jetbrains.com/help/phpstorm/using-php-code-sniffer.html#configure-php-code-sniffer-script-associated-with-php-interpreter

image::doc/img/phpstorm-settings-php-codesniffer.png[]

[TIP]
====
* In *Coding standard*, select *Custom* and choose the `phpcs.xml` file of this repository.
* After the configuration of *PHP_CodeSniffer*, *PHPStorm* will highlight the problematic lines in the files and can run *PHP CS fixer*.
====

{back_to_top}

=== PHP Mess Detector script associated with a PHP interpreter

==== Installation

NOTE: See https://packagist.org/packages/phpmd/phpmd

```
$ composer require --dev phpmd/phpmd
```

==== Configuration

NOTE: See https://www.jetbrains.com/help/phpstorm/using-php-mess-detector.html#configure-a-php-mess-detector-script-associated-with-a-php-interpreter

image::doc/img/phpstorm-settings-php-mess-detector.png[]

TIP: In *Custom rulesets*, click on *+* and choose the `phpmd.xml` file of this repository.

{back_to_top}

== Style Guide

=== JSON naming convention

[NOTE]
====
* https://stackoverflow.com/questions/5543490/json-naming-convention-snake-case-camelcase-or-pascalcase
* https://google.github.io/styleguide/jsoncstyleguide.xml?showone=Property_Name_Format#Property_Name_Format
====

That project (API & SPA) use the `camelCase` format for the property names of JSON responses:

```
{
  "thisPropertyIsAnIdentifier": "identifier value"
}
```

{back_to_top}

=== Exceptions: return errors into JSON format

[NOTE]
====
* https://symfony.com/doc/current/controller/error_pages.html#working-with-the-kernel-exception-event
* https://symfony.com/doc/current/event_dispatcher.html#creating-an-event-listener
* https://symfonycasts.com/screencast/deep-dive/flatten-exception
* https://openclassrooms.com/fr/courses/7709361-construisez-une-api-rest-avec-symfony/7795134-gerez-les-erreurs-et-ajoutez-la-validation
====

In this project, *I will not use a listener or subscriber to force all errors into JSON format*. As for example with the following subscriber:

```php
namespace App\EventSubscriber;

use Symfony\Component\ErrorHandler\Exception\FlattenException;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Event\ExceptionEvent;
use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;
use Symfony\Component\HttpKernel\KernelEvents;
use Symfony\Component\Serializer\SerializerInterface;

class ExceptionSubscriber implements EventSubscriberInterface
{
    public function __construct(private SerializerInterface $serializer)
    {
    }

    public function onKernelException(ExceptionEvent $event): void
    {
        $response = new JsonResponse();

        $exception = $event->getThrowable();
        $flattenException = FlattenException::createFromThrowable($exception);
        $data = $this->serializer->normalize($flattenException);
        $response->setData($data);

        // HttpExceptionInterface is a special type of exception that
        // holds status code and header details
        if ($exception instanceof HttpExceptionInterface) {
            $response->setStatusCode($exception->getStatusCode());
            $response->headers->replace($exception->getHeaders());
        } else {
            $response->setStatusCode(Response::HTTP_INTERNAL_SERVER_ERROR);
        }

        $event->setResponse($response);
    }

    public static function getSubscribedEvents(): array
    {
        return [
            KernelEvents::EXCEPTION => 'onKernelException',
        ];
    }
}
```

Instead, I'll let the user choose the format of the response (HTML, JSON, XML or other) by properly using the `Accept` header request:

```
$ curl https://localhost/api/data --header 'Accept: application/json'
```

In the `SerializerErrorRenderer::render()` of Symfony, a `FlattenException` is created from the exception and is passed to the serializer, with the format from the request. `Accept: application/json` change the "preferred format" on the request to JSON.

TIP: In addition, the JSON error will be automatically filled in depending on the environment (dev or prod).

{back_to_top}

== Comments, suggestions?

Feel free to make comments/suggestions to me in the {git_url_current}/issues[Git issues section].

{back_to_top}

== License

"{main_title}" is released under the {git_url_current}/blob/main/LICENSE[*MIT License*]

---

{back_to_top}
